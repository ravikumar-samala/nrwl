"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ts = require("typescript");
const path = require("path");
const workspace_1 = require("@nrwl/workspace");
const workspace_2 = require("@nrwl/workspace");
/**
 * Add ngrx feature exports to the public barrel in the feature library
 */
function addExportsToBarrel(options) {
    return (host) => {
        if (!host.exists(options.module)) {
            throw new Error(`Specified module path (${options.module}) does not exist`);
        }
        // Only update the public barrel for feature libraries
        if (options.root != true) {
            const moduleDir = path.dirname(options.module);
            const indexFilePath = path.join(moduleDir, '../index.ts');
            const hasFacade = options.facade == true;
            const addModels = options.syntax === 'creators';
            const buffer = host.read(indexFilePath);
            if (!!buffer) {
                // AST to 'index.ts' barrel for the public API
                const indexSource = buffer.toString('utf-8');
                const indexSourceFile = ts.createSourceFile(indexFilePath, indexSource, ts.ScriptTarget.Latest, true);
                // Public API for the feature interfaces, selectors, and facade
                const { fileName } = workspace_1.names(options.name);
                const statePath = `./lib/${options.directory}/${fileName}`;
                workspace_2.insert(host, indexFilePath, [
                    ...(hasFacade
                        ? workspace_2.addGlobal(indexSourceFile, indexFilePath, `export * from '${statePath}.facade';`)
                        : []),
                    ...workspace_2.addGlobal(indexSourceFile, indexFilePath, `export * from '${statePath}.reducer';`),
                    ...(addModels
                        ? workspace_2.addGlobal(indexSourceFile, indexFilePath, `export * from '${statePath}.models';`)
                        : []),
                    ...workspace_2.addGlobal(indexSourceFile, indexFilePath, `export * from '${statePath}.selectors';`)
                ]);
            }
        }
        return host;
    };
}
exports.addExportsToBarrel = addExportsToBarrel;
